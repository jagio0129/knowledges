データベースとアーキテクチャ構成
===
## <font color=magenta>データベースのアーキテクチャについて考える</font>
「可用性が低い(サーバが一台しかないと、そのサーバに障害が起きたときにシステムが停止してしまう)」と「拡張性が低い(サーバが一台しかないと、当該サーバの性能に限界が来たときにサーバをより上位のマシンに変更したりより高性能のパーツに変更しない限り対応のしようがない)」などの問題を抱えることがあります。

この問題を解消するには２つの方法が考えられます。

１つ目は、サーバ一つの性能を信頼できるレベルまで高めることです。ハード的・システム的に性能を向上させることで障害の起きない・性能限界のこない仕様にすることができれば問題は解消されますが、現実的には難しい対処法です。

２つ目は、サーバ一つの性能を極限に高めるのではなく・対応できるサーバの数を増やすことです。一つのサーバに障害が起きたとしても他のサーバで運用を継続でき、処理も分散できるため現実的な解決方法といえます。この場合のように、同等の機能を持つコンポーネントを並列させることを**クラスタリング**といいます。また、クラスタ構成を組んでシステムの稼働率を高めることを**冗長性を確保する**といいます。

### <font color=orange>単一障害点(SPOF: Single Point of Failure)</font>
あらゆるコンポーネントを無限に並列させることができれば、その全てに同時多発的に障害が起きない限りシステムは稼働し続けることができます。しかし、現実問題これを実現することは不可能です。多重化されていないある部分に障害が起きるとシステム全体が停止してしまうようなコンポーネントのことを**単一障害点(SPOF)**といいます。

![spof](https://www.computerhope.com/jargon/s/spof.jpg)

## <font color=magenta>DBサーバの冗長化</font>
データを一時的に保持するだけのwebサーバやアプリケーションサーバとちがい。DBサーバは**データを永続的に保持**して置かなければなりません。加えて高速に読み書きできるパフォーマンスも考慮されなければなりません。そのためDBサーバでは、データが保存されるストレージやデータの読み書きの性能に関わるCPUやメモリ、データに矛盾がないか(整合性が取れているか)管理するシステムについても考慮されなければなりません。

CPUやメモリに関しては、性能の良いものを使用したり数を増やしたりすることで冗長化を図ることができますが、ストレージとなると話は難しくなります。単純にストレージを増やすにしても「どのデータをどこに置くのか」「どこから呼び出せばいいのか」など、冗長性を確保するためにも**データの整合性**を考慮する必要があるからです。

### <font color=orange>最も単純な冗長化</font>
最も単純な冗長化は**ストレージを一つにしてしまうこと**です。

![test](http://www.plantuml.com/plantuml/png/SoWkIImgAStDuKfCJyqhKN1nUjoqzN7pdiVD4mmnXOouYaloYu322e-RTZvkxdZSl0OaqRI3YmjPeuAkhYw62cHZi2fmICrB0Je40000)

ストレージひとつなのでデータの整合性を考える必要がありません。

DBサーバは2台ありますが、同時に動作できるかどうかで構成が変わってきます。両方とも稼働する場合を「Active-Active」、一台だけ稼働させもう一台は稼働しているサーバのヘルスチェックを行い待機している場合を「Active-Standby」とします。ストレージを共有したActive-Activeが利用できるDBMSのは現在ではOracleとDB2だけのようです。ほかは「Active-Standby」の構成を取るようです。

「Active-Active」ではDBサーバが並列で稼働しているため、一台のDBサーバに障害が起きたとしても他のDBサーバで役割をカバーできます。また、DBサーバを並列化しているのでパフォーマすの向上も見込めます。ただし単一のストレージを利用しているためここがボトルネックとなり思ったほどのスケーラビリティを見込めない場合があります。

「Active-Standby」ではActiveなDBサーバに障害が起きた場合、StandbyのDBサーバがそれを検知しActiveとなります。この切替をファイルオーバーといいます。切り替えには多少の時間がかかり、この間ストレージへのアクセスはできなくなります。Standby側がどうやってActiveなDBサーバのヘルスチェックを行っているかというと、一定間隔でActive側に以上がないか通信を行っており、これをHeatbeat通信と言います。

### <font color=orange>レプリケーションとはなにか</font>
要するにサーバとストレージをレプリケーション(複製)することです。前述した構成ではストレージが単一であるためストレージに障害が起きた場合データが消失することになります。DBサーバとストレージの構成を複数用意することでデータの消失を防ぐことになります。

レプリケーションで注意して置かなければならないことは、「データは更新されている」ということです。複製を行った後に可動側に更新が入り同期される前に障害が起きた場合、障害が起きた時点のデータと複製されたデータとでは差分がうまれ整合性が取れなくなってしまいます。同期間隔を短くすることで整合性を高めることはできますが、頻繁に同期通信を行うことになりパフォーマンスが下がってしまいます。

### シェアードディスクとシェアードナッシング
複数のDBサーバ構成に対してストーレジが単一(共有されている)構成を**シェアードディスク型**と呼びます。シェアードディスク型の「Active-Active」構成では、ストレージを簡単に増やせないことと、DBサーバをいくら増やしてもスループットが向上しない限界点があります。スループットとは一定時間あたりの処理能力のことです。DBサーバを増やす毎にDBサーバ間の情報共有のためのオーバーヘッドが大きくなってしまうからです。オーバーヘッドとはある処理を行う際に関節的にかかってしまうコストのことです。

この欠点を解消するアーキテクチャがネットワーク以外の構成をすべて分離する**シェアードナッシング**という構成です。

![](https://www.fujitsu.com/jp/Images/function2_9_tcm102-2056468.gif)

この構成では、DBサーバとストレージのセットを増やせば線形的にスループットも向上するというメリットがあります。しかし、ディスクを共有していないため、あるDBサーバに障害が起きてしまうとそのDBサーバが持つデータを扱うことができなくなりでもリットもあります。障害の起きたDBサーバの役割を他のDBサーバが巻き取るという構成を保つ必要が出てきます。