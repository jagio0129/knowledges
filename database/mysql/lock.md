MySQLのロック
===

## ロックとは

データベース上の同一データに対して書込み要求が同時に発生した場合、トランザクションが逐次化されていないと結果に矛盾が生じてしまう。

以下図を見ればロックがなぜ必要なのか直感的にわかる

![](https://static.wixstatic.com/media/b51750_98f1ecfbcd5b45d9a981638a5f4f0672~mv2.png/v1/fill/w_718,h_521,al_c,lg_1,q_90/b51750_98f1ecfbcd5b45d9a981638a5f4f0672~mv2.webp)

> 引用: https://www.teradata-jp.com/post/col05i

## トランザクションとは

「複数の処理を一つにまとめたもの」

https://qiita.com/zd6ir7/items/6568b6c3efc5d6a13865

上の記事がトランザクションの役割を表している。ここではトランザクションの特性について見ていく。

### ACID特性
トランザクションはACID特性を満たしていなければならない

|特性|説明|
|---|---|
|原子性(atomicity)|トランザクションは完全に実行完了するか、全く実行されないかのどちらかでなくてはならない|
|一貫性(consistency)|トランザクションの終了状態に関わらず、データベースの整合性が保たれていなければならない|
|独立性(isolation)|トランザクションを複数同時実行しても、単独実行の場合と同じ処理結果にならなければならない|
|耐久性(durability)|トランザクションの結果は障害が発生しても失われてはならない

## 共有(shared)ロック

読み取りのために使われるロック。INSET/UPDATEが行えなくなる。読み込みはできる。

他の共有ロックと競合しないので、同じレコードに対していくつも共有ロックを取ることができる

## 排他(exclusive)ロック

更新のために使われるロック。他のトランザクションからは更新はできない。読み込みは悲観的ロックか楽観的ロックかで可否が分かれる。

排他ロックの制御方法にはいくつか種類がある

### 楽観的ロック
めったなことでは他者との同時更新は起きないであろう、という楽観的な前提の排他制御。

データそのものに対してロックは行わずに、更新対象のデータがデータ取得時と同じ状態であることを確認してから更新することで、データの整合性を保証する方式。

### 悲観的ロック
他者が同じデータに頻繁に変更を加えるであろう、という悲観的な前提の排他制御。

更新対象のデータを取得する際にロックをかけることで、他のトランザクションから更新されないようにする方式。

データのロックはRDBMSの「SELECT 〜 FOR UPDATE」を利用して実現されるのが一般的。悲観ロックでは、ロックの解放漏れがあると、いつまで経っても他者が操作できないということに繋がるため、データ更新後はロックの解放を必ず行うこと。

## 共有ロックと排他ロックの関係性

|-|共有ロック|排他ロック|
|---|:-:|:-:|
|共有ロック|○|×|
|排他ロック|×|×|

「共有ロックがかかっているレコードに墓のトランザクションが行えるのは共有ロックとだけ」ということになる。それ以外の場合はwait(待ち)が発生する・

## トランザクション分離レベル

トランザクションの変更が他のトランザクションでどのように見えるのか、トランザクション同士の影響レベルのこと。

他のトランザクションとの影響についてはいくつか種類がある

### 分離レベルの種類

|分離レベル|ダーティリード|ノンリピータブルリード|ファントムリード|
|---|---|---|---|
|READ UNCOMMITED|○|○|○|
|READ COMMITED|×|○|○|
|REPEATABLE READ|×|×|○|
|SERIALIZE|×|×|×|

MySQLではREPEATABLE READがデフォルト。

トランザクションをサポートしているRDBMSではトランザクションの並列性を上げることが性能アップをの一つ。競合を防ぐためにSERIALIZEにしていては性能が落ちてしまう。

### ダーティリード

![](https://techracho.bpsinc.jp/wp-content/uploads/2018/12/dirtyread.png)

あるトランザクションが更新されている最中に、他のトランザクションからデータを読み出すことができてしまう現象のこと。

排他ロックを悲観的ロックにすれば発生しない。

### ノンリピータブルリード(ファジーリード)

![](https://techracho.bpsinc.jp/wp-content/uploads/2018/12/non-repeatable-read.png)

同じトランザクションで再度同じ行を読み込んだときに、その行が更新または削除されていること。

こちらも排他ロックを悲観的ロックにすることで発生しない

### ファントムリード

![](https://techracho.bpsinc.jp/wp-content/uploads/2018/12/phantom-read.png)

ある探索条件を満たす行の集合を読み込んだ後、ほかのトランザクションによる行の挿入または更新により、その探索条件を満たす行が生成され、再度同じ探索条件を読み込んだときに、異なる行の挿入が得られる。

トランザクション1がテーブルに対して共有ロックを取ることで防げる


## MySQL(InnoDB)でファントムリードを防ぐ仕組み
MySQL(InnoDB)ではトランザクション分離レベルをREPEATABLE READに設定してもファントムリードは発生しない。

これはMySQLのロック機構であるギャップロックとネクストキーロックのおかげである。

MySQLのロック機構は[公式リファレンス](https://dev.mysql.com/doc/refman/5.6/ja/innodb-record-level-locks.html#:~:text=INSERT%20%E6%93%8D%E4%BD%9C%E3%81%A7%E3%81%AF%E8%A1%8C%E3%81%AE,%E3%81%93%E3%81%A8%E3%82%92%E7%A4%BA%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82)でも丁寧に解説されている

### レコードロック
- いわゆる行ロック。
- インデックスレコードに対するロックである。
- テーブルにインデクスが貼ってなくても常にインデックスレコードをロックする
  - 主キーがクラスターインデックスで有ることに起因する

### ギャプロック
- レコードとレコードの間に対するロック
- インデックスの先頭レコードの前に対するロック
- インデックスの最後のレコードの後ろに対するロック
- 分離レベルをREAD COMMITED以下にすれば発生しない

### ネクストキーロック
- レコードとその前に対するロック
- レコードロック + ギャップロック
- これによりファントムリードを防ぐ

### インテンションロック
上3つが行レベルロックであるのに対し、インテンションロックはテーブルレベルロックである

- インテンション共有ロック（IS）
  - SELECT ～ LOCK IN SHARE MODEで設定される
- インテンション排他ロック（IX）
  - SELECT ～ FOR UPDATEや更新系の SQL で設定される

INSERT 操作では行の挿入前に、挿入インテンションギャップロックと呼ばれる一種のギャップロックが設定される。
このロックは、同じインデックスギャップに挿入する複数のトランザクションは、そのギャップ内の同じ場所に挿入しなければ相互に待機する必要がないように、意図的に挿入することを示している。

「テーブルロック」というと「ロックすると他のトランザクションが（当該テーブルに）一切更新（または参照）できなくなる（待たされる）」というイメージがあるかもしれないが、そういうわけではなく、下に示したリファレンスマニュアルのマトリクス表で「互換性がある」と示されている組み合わせであれば重複してロックを取ることができる。

[InnoDB のロックモード](https://dev.mysql.com/doc/refman/5.6/ja/innodb-lock-modes.html)

結局のところ、これらのテーブルロックを取っただけでは他のトランザクションがブロックされることはほとんどなく（明示的にLOCK TABLES ～ WRITEなどを実行した場合を除いて）、基本的には「（誰かが）テーブル内の行をロック（しようと）していることを示す」ためのもの。

## 参考サイト

- [MySQL(InnoDB)でのDeadLock調査](https://qiita.com/h-oikawa/items/91e2401fad5d93262f6f)
- [MySQL with InnoDB のインデックスの基礎知識とありがちな間違い](https://techlife.cookpad.com/entry/2017/04/18/092524)
- [楽観的ロックと悲観的ロック](https://qiita.com/NagaokaKenichi/items/73040df85b7bd4e9ecfc)
- [トランザクション分離レベルについて](https://techracho.bpsinc.jp/kotetsu75/2018_12_14/66410)
- [MySQLのギャップロックとネクストキーロックについて](https://speakerdeck.com/yoshiakiyamasaki/lt-mysqlfalsegiyatupurotukutonekusutokirotukunituite?slide=9)
