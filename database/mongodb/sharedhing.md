シャーディング
===

シャーディングとは、データを複数のサーバに分散させる機能の事。

## シャーディングのメリット

### 負荷分散による性能の向上

データを複数のサーバに分散させることで、CPU
やI/O負荷を分散させることが可能。MongoDBではキーの範囲でデータの分散ができる。適切なキー範囲を設定することにより、負荷を水平スケーリングさせることが可能。

### リソース分散によるコストパフォーマンスの向上

１環境のさいずがおおきいほど価格の上昇幅が大きくなる。複数のサーバにデータを分散させることが、コストパフォーマンスの向上につながる。MongoDBではメモリが性能に直結するため、十分なサイズのメモリを確保することが推奨されている。

## シャーディングの概要
### シャードキーのレンジによるデータ分散

MongoDBのシャーディングはレンジパーティション方式を採用している。シャードキーを指定することで、各サーバに格納されるデータの範囲が決定される。サーバ間で重複データを持たず、１つのデータが格納されるサーバはシャードキーの範囲によって一つに決定される。

![](https://gihyo.jp/assets/images/dev/serial/01/mongodb/0005/thumb/TH800_001.jpg)

### 自動バランシング

キー範囲の調整と、調整に伴うサーバ間のデータの移動まで全部MongoDBが行う自動バランシングという機能を備えている。これにより、サーバ間のデータの偏りをユーザが意識しなくても良いように設計されている。また、新たにサーバを追加した場合も、同様にデータの移動を行い偏りがなくなるように自動調整する。

## キーワード
### シャード
実際にデータが格納されているmongodbプロセス。一つのドキュメントは1つのシャードに格納され、シャード感でデータの複製は行わない。

### configサーバ
シャーディングのメタデータを管理しているmongodプロセス。単膣障害点となるので複数のサーバで構成することが推奨されている。

### mongosサーバ
シャーディングにおけるルーティングプロセス。シャードとクライアントを連携させる。必要があれば複数のmongosサーバを立てることが可能。mongodプロセスではないので、状態やデータを持っていない。

### シャードキー

データを分散する範囲のキー。複数指定もできる。キー上のどの範囲のデータがどのシャードに格納されるかはMongoDBが管理し、データの偏りによって自動調整を行う。シャーディングにおいて、シャードキーの設計が非常に重要になる。

### チャンク
チャンクとは分散するデータの単位。具体的には、あるコレクションの連続した範囲のデータで、複数のドキュメントとなる。チャンクの最大サイズに達すると分割され、シャードが持っているチャンク数に応じて必要ならば他のシャードに移動される。

## 参考
- [Sharding](https://docs.mongodb.com/manual/sharding/)
- [MongoDBのシャーディングを試してみよう](https://gihyo.jp/dev/serial/01/mongodb/0005)
