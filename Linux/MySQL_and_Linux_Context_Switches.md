MySQL and Linux Context Switches - PERCONA
===

> [原文](https://www.percona.com/blog/2017/11/09/mysql-linux-context-switches/)

今回のブログでは、MySQLとLinuxのコンテキストスイッチについて、またデータベース環境における1秒あたりの正常な数について見ていきたいと思います。

MySQLが内部競合の問題に悩まされているかどうかを示すために、コンテキストスイッチの数を見ることの重要性について、何度も聞いたことがあるかもしれません。よく、「正常な」あるいは「許容できる」数値とは何か、どの時点で1秒あたりのコンテキストスイッチの数を気にする必要があるのか、という質問を受けることがあります。

まず、Linuxにおけるコンテキスト・スイッチとは何なのかについて説明します。このStackOverflowのスレッドでは、多くの詳細を含む良い議論を提供していますが、基本的には次のように動作します。

プロセス（MySQL の場合はスレッド）は計算を実行しています。遅かれ早かれ、ディスクIO、ネットワークIO、ミューテックス待ちブロック、イールドなど、何らかのブロック処理を行わなければならない。一方、プロセス/スレッドは、割り当てられたCPU時間を使用したため（そして今は他のタスクを実行する必要がある）、または優先度の高いタスクを実行する必要があるため、スケジューラによって先取りされる必要がある場合があります。これは不本意なコンテキストスイッチと呼ばれます。システム内のすべてのプロセスを合計すると、システム全体で報告されるコンテキストスイッチの数になります（vmstatなどを使用）。

```shell
root@nuc2:~# vmstat 10
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
17  0      0 12935036 326152 2387388    0    0     0     5     0      1  9  0 91  0  0
20  0      0 12933936 326152 2387384    0    0     0     3 32228 124791 77 22  1  0  0
17  0      0 12933348 326152 2387364    0    0     0    11 33212 124575 78 22  1  0  0
16  0      0 12933380 326152 2387364    0    0     0    78 32470 126100 78 22  1  0  0
```

これはグローバルな数です。しかし、多くの場合、CPU論理コアごとのコンテキストスイッチとして見たほうがよいでしょう。これは、コアが独立してタスクを実行するためです。そのため、コンテキストスイッチの原因もほぼ独立しています。コアの数が多い場合は、かなり差が出る可能性があります。

![](https://www.percona.com/blog/wp-content/uploads/2017/11/MySQL-Context-Switches-1024x283.png)

このシステムでは、1秒あたりのコンテキストスイッチの数が多いように見えます（1,000,000以上）。しかし、論理コアが56個あることを考えると、1論理コアあたり1秒間に約3万回に過ぎません（これは悪くない）。

では、システムにおいてコンテキストスイッチの回数が多すぎるかどうかは、どのように判断すればいいのだろうか。1つの答えは、コンテキストスイッチに多くのCPUを浪費している場合は高すぎるということです。コンテキスト・スイッチだけを行う場合、システムはどれだけのコンテキスト・スイッチを処理できるのでしょうか？

これを調べるのは簡単です!

Sysbenchには、これを測定するために特別に設計された "threads "テストがあります。例えば

```shell
sysbench --thread-locks=128 --time=7200 --threads=1024 threads run
```

vmstatの出力やContext Switches PMMのグラフをチェックしてみてください。

![](https://www.percona.com/blog/wp-content/uploads/2017/11/MySQL-Context-Switches-1.png)

このシステムは、合計で毎秒3500万回のコンテキストスイッチを処理できることがわかります（または、論理CPUコアあたり平均で約50万回）。

私は、CPUリソースの10％以上をコンテキストスイッチに使用することは推奨していませんので、コンテキストスイッチの数を論理CPUコアあたり5万回以下に抑えるようにします。

では逆に、ある負荷に対して、最低限どれだけのコンテキストスイッチが必要か？という観点からコンテキストスイッチについて考えてみましょう。仮に、MySQL へのクエリにディスク IO やミューテックス待ちによるコンテキストスイッチが必要ないとしても、少なくとも 2 つのコンテキストスイッチが発生するはずです。

このロジックでは、100,000クエリ/秒の場合、最低でも200,000回のコンテキスト・スイッチが発生することになります。

しかし、実際のところ、1回のクエリでコンテクストスイッチが10回以下であれば、競合が大きな問題となる心配はないだろう。

MySQLでは、すべての競合がコンテキストスイッチになるわけではないことは注目に値する。InnoDBは独自のミューテックスとRWロックを実装しており、リソースが利用可能になるのを待つために、しばしば「スピン」しようとする。これは、コンテキストスイッチを行うよりも、CPU時間を直接浪費しています。

比較しやすいように、合計ではなく、論理コアごとのコンテキストスイッチの数を見ます。
システムが1秒間に処理できるコンテキストスイッチの数を調べ、コンテキストスイッチがその数の10％以下であれば、あまり気にしないでください。
クエリごとのコンテキスト・スイッチの数について考える。可能な最小値は 2 で、10 未満の値では競合は起こりにくい。
MySQL のすべての競合が、多数のコンテキストスイッチになるわけではありません。

### まとめ
- 比較しやすいように、合計ではなく、論理コアごとのコンテキストスイッチの数を見ます。
- システムが1秒間に処理できるコンテキストスイッチの数を調べ、コンテキストスイッチがその数の10％以下であれば、あまり気にしないでください。
- クエリごとのコンテキスト・スイッチの数について考える。可能な最小値は 2 で、10 未満の値では競合は起こりにくい。
- MySQL のすべての競合が、多数のコンテキストスイッチになるわけではありません。
