# Linux基礎

## Linuxとは

UNIXをベースにしたOS。厳密に言うとLinuxとは「[カーネル](#カーネルとは)」をさす。

#### LinuxはOSS

LinuxはGPL（GNU Public License）に基づいたOSSである。つまりLinuxのソースコードは誰でも見れるようになっている。

## カーネルとは

コンピュータは大きく分けて「ハードウェア」と「ソフトウェア」の２つに分けられる。カーネルはこのソフトウェアの中でも最もハードウェアと密接に関わっている部分。主な機能は

- CPUのコントロール
- メモリの管理
- ディスクコントロール
- タスクの管理 Linuxではシステムとして機能を幾つかのプログラム（＝タスク、プロセス）として実行、実現している。それらのプロセスを動かすのもカーネルの機能。

## パッケージとは

通常、プログラムはコンパイルしてバイナリに変換しなければならない。わざわざユーザがコンパイルする作業を省くために、あらかじめコンパイルされたバイナリと幾つかの必要なファイルをひとまとめにしたものが「パッケージ」

#### パッケージの依存関係

パッケージには依存関係というものがある。例えば、ある特定のソフトウェアを実行するためにはある特定のライブラリが必要といった具合に、複数のプログラムやライブラリなどが必要に応じて関連付けられている。ソフトウェアを正しく動作させるためには依存関係のあるプログラムやライブラリがインストールされていなければならない。
#### パッケージ形式と依存関係、パッケージ管理ツール

パッケージは、その構造と管理のされ方によって幾つかの種類にわけられる。Linuxでよく使われているのは、RPM形式とdeb形式。どちらも単にインストールを行うのではなく、パッケージの依存関係をチェックしながらパッケージのインストールやアンインストールを行ってくれるツール。RPMやdebを使えば、インストールしたのに依存関係のあるパッケージがインストールされていないため動かない、依存関係のあるパッケージを削除してしまったために別のソフトが動かないなどのトラブルが起きにくい。

## ライブラリとは

コンピュータ上で動作するプログラムはカーネルを通してハードウェアを制御する。しかし、カーネルが行っている処理は非常に細かい（低レベル）なので、このままプログラムが処理を支持すると非常に煩雑な作業となってしまう。

そこで、より簡単に大まか（高レベル）に処理を指示できるようにしたものが「ライブラリ」。特にコンピュータとしての基本的な処理をC言語から使用する場合のライブラリを「標準ライブラリ」と呼び、OSの違いによらず利用できるものとなっている。その規格はANSIで標準化されている。

## ディストリビューションとは

ディストリで大きく異なるのがパッケージの管理方法。大雑把に分けるとRPM形式、deb形式、その他にわけられる。

RPM形式は特にRed Hat Linuxから派生したディストリに使われる。 deb形式はDebian GNU/Linuxから派生したディストリで使われる。

## ユーザとは

LinuxはマルチユーザOSと言われている。これは、複数人が同時に、一大のマシンのリソース（CPUやメモリ）を使用できるということ。##### ユーザの役割

ユーザの役割は、Linux上でプログラムを実行し、プロセスを生成することにある。これは、Linuxカーネル上の全ての動作が、基本的にプロセス中心で成り立っているから。逆をいえば、Linux上で動いているプロセスは必ずいずれかのユーザが起動したものとなっている###### スーパーユーザー

Linuxのユーザの中でも特別なユーザ(root)。rootはLinuxカーネルが最初に起動する「init」プロセスの起動ユーザであり、動作中のLinuxのリソース全てへのアクセス権限がある。このため、rootは特権ユーザとも呼ばれる。

rootだけが行えることは

- ファイルシステム上にある全てのファイル操作ができる
- ファイルシステム上にある全ての実行ファイルを実行できる
- Linuxをシャットダウンできる
- TCP/IPのポート番号1024以下を使用できるのはrootが起動したプロセスだけ

## グループとは

LinuxはマルチユーザOSであるが、ユーザはそれぞれが全くバラバラであるというわけではない。「グループ」という概念でまとめて管理されてい####
### グループの役割

最も大きな役割はファイル/ディレクトリのパーミッションとの対応である。 ファイル/ディレクトリには所有ユーザとは別に、それらを所有するグループに対して読み書き実行のパーミッションが設定されている。これにより異なるユーザ同士でのファイル/ディレクトリの共有をコントロールすることがで####

### メイングループ

各ユーザは、最低一つどこかのグループに所属している必要がある。ユーザが最初に所属するグループを「メイングループ」####。

### サブグループ

ユーザはメイングループを一つしか持つことができない。これではパーミッションの管理棟に柔軟性を持たせることができないので、ユーザは複数のグループに所属することができるようになっている。この、メイングループ以外にユーザが所属知っているグループを「サブグループ」という。

## ファイルシステムとは

ディスク上のどこに何というファイルがあるのか、といった情報を管理しているのがファイルシステム。ファイルの読み書きは、ファイルシステムの情報を元に行われる。ファイルシステムはOSごとに異なるが、Linuxではext2またはext3というファイルシステムが一般的に使わ####る。

### ファイルシステムの構造

Linuxのファイルシステムは、WindowsやMac OSと同じように、ツリー状の階層的な構造を持っている。WindowsやMac OSでの「フォルダ」は、Linuxでは「ディレクトリ」と呼ばれる。

ファイルシステムの根っこにあたるのがルートディレクトリで「####表す。

### 相対パスと絶対パス

「/」から表記する方法を「絶対パス」という。「/etc/hosts」なら「etcディレクトリの下にあるhostsファイル」ということになる。

相対パスの場合、カレントディレクトリが「/home/linux」だとすると、絶対パス「/home/linux/etc/hosts」は「etc/hosts」と表現できる。またカレントディレクトリを指す場合「.」、カレントディレクトリの一つ上のディレクトリを指す場合「..」####できる。

### マウント

Windowsにはドライブと言う概念があり、ハードディスクはCドライブ、Dドライブなどと表現する。Linuxは、すべて唯一のルートディレクトリを出発点としているため、複数のハードドライブを扱う場合「マウント」という仕組みを使っている。

マウントとは、別のディレクトリツリーを、ルートディレクトリ以下のディレクトリツリー####すること。

### ファイルシステムの種類

よく使われるファイルシステム一覧

File System | 概要
:---------- | -----------------------------------------------------------------------------------------------------
ext2/ext3   | イー・エックス・ティー・ツー（スリー）と読みます。Linuxの標準的なファイルシステムです。最近（Red Hat Linux 7.2以降）は、ext2の後継にあたるext3がデフォルトで使われています。
FAT/FAT32   | MS-DOSやWindowsで使われているファイルシステムです。Windows98以降は、FATではなく大容量ディスクをより効率的に扱えるFAT32が使われています。
NTFS        | WindowsNT/2000/XPで使われているファイルシステムです。
ReiserFS    | ジャーナリング機能を持ったファイルシステムで、ファイルの読み書きが速い、異常終了した時などの修復が速い、などの特徴があります。
iso9660     | CD-ROMの標準的なフ####システムです

### FHS(ファイルシステム階層基準)

Linuxには多くのディストリがあるが、ディレクトリやファイルの配置はディストリによって微妙に異なる。しかし、これでは不便なので、FHSと呼ばれるディレクトリやファイルの配置に関する標準仕様が策定されてきている。最近では多くのディストリでFHSを採用したディレクトリ・ファイル配置になるようになってきている。

## スワップ領域とは

スワップ領域とは、仮想メモリ使用時に不必要なメモリのデータを一時的に書き込んでおくファイルシステム上の領域のこと。

仮想メモリは、実際にコンピュータに搭載されているメモリだけではなく、ハードディスクなどに用意されたスワップ領域も仮想的にメモリとみなして、より大きなメモリ容量を実現する仕組み。しかし実際のメモリに比べてハードディスクは読み書きの速度が極端に遅いので、CPUとの間でのデータのやり取りはあくまでも実メモリで行う。スワップ領域は、実メモリ上にある必要のないデータを対比しておき、実メモリに空きを作るために使用される。このように不要なデータを対比することを「スワ####ウト」と呼ぶ。

### スワップパーティションとスワップファイル

Linuxはスワップ領域用のファイルシステムとしたパーティションを作成する必要がある。容量はシステムによって異なるが、およそ実メモリの２倍が一般的。これ以上の容量を準備したとしても、スワップアウトに時間がかかるため、実用的な速度は達成できないだろう。パフォーマンスを要求するのであれば、常時使用するプロセスのプログラム領域とそのデータがスワップアウトせずにいられる程度の実メモリ容量を確保する必要がある。

スワップパーティションのほかにも、スワップファイルを使うことができる。スワップファイルにスワップアウトする。

## シェルとは

Linuxの中核を担っているのがカーネルだが、もしLinuxにカーネルしかなかったら人間はコンピュータを操ることができない。なぜならカーネルは人間との意思の疎通を図る機能を持っていないため。そこで、カーネルと人間が意思の疎通を図れるよう、通訳の役割を担う存在が必要になる。この役割を担うのが「シェル」

テキストログインでログインするとプロンプトが現れるが、この時に動いているのがシェル。ユーザは、プロンプトに続けてコマンドを打ち込むことによってLinuxを操作する。この操作ではユーザはカーネルと直接会話しているのではない。

ユーザがコマンドを打ち込んだり、コマンドの実行結果を見たり、という「会話」をしている相手は、カーネルではなく実はシェルと呼ばれるもの。

シェルは、ユーザからのコマンド（命令）を、通訳してカーネルに渡す。カーネルからのメッセージも、シェルで通訳されて出力される。シェルの役割はそれだけでなく、ユーザに対して便利な機能を提供する。最近のディストリで標準として採用されているシェル「bash」では、例えば、コマンドプロンプトが表示された状態で上矢印キーを押すと、過去に入力したコマンドが表示される機能（ヒストリ機能）や、ファイル名を途中まで入力してTabキーを押すと、既にあるファイルやディレクトリの名前が自動的に保管される機能（補完機能）が使える。その他にも「リダイレクト」や「パイプ」などの便利な機能も使える。

## コマンドとは

コマンドとは、Linuxの操作を実行するために使う実行ファイルのこと。 コマンドのLinux上での動作を細かくすると、以下のようなる。

- 1.シェルにコマンドを入力する。
- 2.入力された名前のファイルが検索される
- 3.ファイルがプログラムとしてメモリにロードされる
- 4.プログラムが先頭から実行される

入力されたコマンドは、Linuxのファイルシステムのディレクト構造の中から環境変数PATHにしたがって順番に検索される。最初に見つかったファイルが環境変数PATHに含まれていなければ実####ことはできない。

### 外部コマンド

外部コマンドとは、実行形式のファイルになっているもの。コマンド実行時にシェルがディスクからメモリにロードして実行する。

外部コマンドと組み込みコマンドが同じ名前の場合は、組み込みコマンドが実行される。外部コマンドを実行させたい場合には、commandコマンドを使って実行する方法がある。

外部コマンドの例：manコマンド manコマンドとは、マニュアルの表示を行うコマンド。manコマンドの引数に表示したいコマンド####を指定し実行する。

### 組み込みコマンド

組み込みコマンドとは、シェルに組み込まれているコマンドのことを指す。シェルのプログラムにコマンドの処理を行う部分が含まれているので、外部のファイルを実行することはない。

組み込みコマンドの####istoryコマンド

### 実行されるコマンドを探すには

whichコマンドを利用すると、コマンドを入力した時にどのディレクトリにファイルが実行されるのか確認することができる。whichコマンドは環境変数PATHが設定されているディレクト順番に調べていく。そして、最初に見つかったコマンドを表示する。

## プロセスとは

プロセスは、Linux上で動作するプログラムのことを指す。タスクとも呼ばれる。プロセスは様々な方法で生成されるが、最も簡単な方法はシェルからコマンドを実行すること。実行されたコマンドプログラムは、コマンドファイルの内容がメモリにロードされて、先頭から実行されていく。プログラムの実行が終わるとプロセスも消失する。

プロセスには親子関係があり、親プロセスが子プロセスを生成する。Linuxカーネルの起動後、一番最初にinitという名称のプロセスを生成することでLinuxはシステムを構成している。ユーザがLinuxにログインすると、ログインシェルプロセスが生成される。ユーザがコマンドを実行すると、ログインシェルプロセスを親に対してコマンドの子プロセスが生####る仕組みになっている。

### プロセスの確認

LinuxはマルチタスクOSなので、システム上で同時に複数のプロセスが動作している。また、ユーザも同時に幾つものプログラムを実行することが可能である。

Linux上で動作しているプロセスを確認するには、ｐｓコマンドを使用する。ｐｓコマンドをオプションを指定せずに実行すると、そのユーザ自身が実行しているプロセスが表示される。aやxオプションを指定して実行すると、その他のユーザやシステムが実行しているプロセスを確認できる。

**表示の意味**

表示           | 概要
------------ | ---------------
PID          | プロセスごとに割り振られる番号
TTY          | プロセスを実行している制御端末
STAT         | 状態
TIME         | CPU消費時間
CMD（COMMAND） | 実行コマンド

**その他のオプション**

オプション | 概要
----- | --------------------
a     | 全てのプロセスの表示
u     | ユーザ名を含めてプロセスを表示
x     | シェルから実行されていないプロセスを表示
l     ####ロセスの状態を詳細に表示

### プロセスの終了

それぞれのプロセスは処理が終了すると、プロセスもメモリから消失するはず。しかし、何らかの理由でプロセスが終了しない場合がある。このようなプロセスはユーザが直接終了する必要がある。

最も簡単な方法として、コマンドライン上から[Ctrl+C]で終了させることができる。それでも狩猟しない場合には、killコマンドを使用する。killコマンドに終了させたいプロセスのプロセスIDを引数につけて実行する。管理者は全てのプロセスを終了させることができるが、一般ユーザは自分の実行したプロセスしか終了させることができない。

killコマンドはプロセスを終了する以外にもプロセスの実行を中断させたり、プロセスの実行を再開させたりすることができる。それらの動作を支持するには、「シグナル」というオプションを使う。

- 1298番のプロセスを強制終了する。

```
$ kill ?KILL 1298
```

**よく使われるシグナル**

シグナル | 概要
---- | ------------------
TERM | 安全に終了させる
KILL | 強制終了させる
STOP | 中断させる
CONT | 再開させる
HUP  | プロセスを終了後再起動
QUIT | coreファイルを残しながら終了する

## デーモンとは

デーモンはLinuxやUNIXにおいてメモリ上に常駐して様々なサービスを提供するプロセスを指す。

デーモンプロセスは処理要求を待ち続け、要求があると自分自身をコピーしたプロセスを作り、コピーしたプロセスに処理を実行させる。

デーモンの意味は、悪魔の[demon]ではなく守護神の[daemon]。そのためデーモンとして動作するプログラムは、伝統的にプログラムファイル名（プロセス名）の最後に「d」がつけられている。ただし、最後に「ｄ」がついていないものでもデ####として動作するものもある。

### デーモンの事前起動

webサーバなどのように、同時にたくさんの処理を行わなくてはならない場合、クライアントから要求があってから子プロセスを生成すると対応する時間がかかってしまう。

そこでwebサーバはあらかじめクライアントから要求が来る前に、複数の子プロセスを生成しておく。クライアントから接続要求が来ると、事前に生成しておいた子プロセスに処理を行わせる。事前に起動しておくことで、サーバ側での処理を早くすることができる。

デーモンは必要に応じてプロセスを生成するので、要求が多い場合にはその数だけデーモンの子プロセスが必要になる。しかしプロセスの数が増えるとLinuxカーネルがそれらのプロセスの切り替えに手間取るようになるため、逆に処理速度が低下している。子プロセスを事前にいくつ生成するか設定を確認する必要がある。

デーモンは常時動いているプロセスなのでたくさんのデーモンがシステムは負荷が大きく処理に時間がかかることになる。システムを快適に動かすためにも、必要####モンだけを動かす必要がある。

### スーパーデーモン

デーモンの中には、、スーパーデーモンとやバレるものがある。スーパーデーモンは通常のデーモンと同じように要求を待ち続けているが、要求の種類に応じて生成する子プロセスの種類を変更している。

常にたくさんおデーモンが動いていると負荷が大きく処理に時間がかかってしまう。しかしスーパーデーモンは、telnetの処理要求があった場合には、telnetサーバデーモンを起動し、FTPアクセス要求があった場合にはFTPデーモンを起動し処理を行う。

スーパーデーモンを使用することで必要のないデーモンを起動しておく必要がなくなり、コンピュー####かる負荷を減らすことができる。

### シェルスクリプトとは

シェルスクリプトは、複数の処理をまとめて行うOSのシェルが直接解釈・処理できるスクリプトのこと。スクリプトとは、機械語への変換作業を省略して、簡単に実行できるようにした簡易プログラムのこと。

シェルスクリプトは、シェルごとに独自の文法が採用されている。一般的な文法は1行が一つのコマンドとして扱われる。特にLinuxやUNIX系OSのシェルは複雑な繰り返し処理や条件分岐などに対応している。そのためシェルスクリプトだけで、複雑な処理を自動化することができる。

例として、シェルスクリプトを実際に見てみたい場合は、/etc/init.dの中身を確認すれば良い。各種サービスの起動・停止用のシ####クリプトを確認することができる。

#### BシェルとBash

現在利用できる最も振りシェルが「Bシェル(Bourne Shell)。AT＆Tのベル研究所で開発され、開発者の一人であるSteven Bourne氏の名前にちなんで、この名前がつけられた。Bセルはほとんど全てのOSが利用できるので標準的なシェルと言われている。そのためシェルスクリプトの作成にはBシェルがよく用いられる。

LinuxではBシェルの代わりにBシェルを強化した「Bash（Bourne agein shell）」と呼ばれるシェルが使われている。BashはBシェルとの互換性を維持しながら、拡張されている。例えば、変数の照合演算や数値演算など、プログラム言語としても便利な機能が追加されている。その他、ユーザインターフェイスも機能強化され、ヒストリー機能やエイリアスなども追加された。これらの機能により、複雑####ルスクリプトをかけるようになった。

### パーミッションとは

パーミッションとは、ファイルやディレクトリに対する操作に権限を与え、ファイルの保護モードを設定すること。

パーミションには「読み込み」「書き込み」「実行」の３種類があり、それぞれをファイルの「所有者」、「グループユーザ」、「その他のユーザ」に対して設定できる。

パーミッションを表しているのは、表示された左の１０文字。

```
drwxrwxrwx
```

- 一番左のdはディレクトリかどうかを表す
- rwxの３文字を一セットとし、左から「所有ユーザ」「所有グループ」「その他のユーザ」####rは読み込み、wは書き込み、xは実行

#### パーミッションの変更

パーミッションが変更できるのは、そのファイル（ディレクトリ）の所有者、もしくはroot権限者に限られる。パーミッションの変更にはchmodコマンドを使う。

```
chmod モード ファイル名（ディレクトリ名）
```

chmodコマンドの引数の「モード」には「誰に」「何を」「許可するか禁止するか」という情報を与える。

「誰に」については

comannd | discription
------- | -----------
u       | user
g       | group
o       | others
a       | all

「許可するか禁止するか」については

comannd | discription
------- | -----------
+       | 許可する
-       | 禁止する

「何を」については

command | discription
------- | -----------
r       | read
w       | write
x       | execute

chmodの組み合わせ例

command | discription
------- | --------------
u+x     | 所有ユーザに実行を許可
a+rwx   | 全てのユーザに全てを許可
go-rwx  | 所有ユーザ以外すべて禁止
g+####   | 所有グループに読み込みを許可

#### ディレクトリのパーミションについて

ディレクトリのパーミッションの意味は、ファイルと少し異なる。

param         | discription
------------- | -------------------------------------------------------------------------------------------------------------
r 読み込み(Read)  | そのディレクトリの情報を見ることができるか（そのディレクトリに対してlsコマンドが実行できるか ただし「実行(x)」パーミションがせて治されていないと「-l」オプションが設定されていないと「-l」オプションは使えない）
w 書き込み(Write) | そのディレクトリに新しいファイルを作成することができるか（同時に「実行（ｘ）」パーミッションの設定が必要）
x 実行（eXecute） | そのディレクトリをカレントディレクトリにできるか（そのディレクトリに対してcdディレクトリに対してcdコマンドが実行できるか)

## デバイスとは

デバイスは、コンピュータに接続された各種周辺機器のこと。Linuxではデバイスは全て「デバイスファイル」という特殊なファイルとして認識される。Linuxは、デバイス####ルを通じて入出力を行うようになっている。

### デバイスの種類

デバイスは「ブロックデバイス」と「キャラクタデバイス」の２種類に分類される。デバイスが入出力データをどのように取り扱うかによって分類される。

ブロックデバイスはデータをある一定の塊（ブロック）としてやり取りを行う。ブロックデバイスは大量のやり取りを行うのに向いている。例えば、ハードディスクのような機器はブロックデバイスである。

キャラクタデバイスは文字通り一文字ごとのやり取りをおこなう。キャラクタデバイスは少量のやり取りに向いており、キーボードなどがキャラクタデバイスである。

デバイスファイルは/devディレクトリに配置されている。lsコマンドに-lオプションを付けて実行すると、結果の最初の文字でそれぞれのデバイスがブロックデバイ####ャラクタデバイス化を確認することができる。

#### ハードディスクのデバイスファイル

IDEドライブには、プライマリとセカンダリの２つのバスが有り、それぞれにマスターとスレーブの２系統が用意されている。これらのはどディスクパーティションを分ける場合は「/dev/hda1」「/dev/hda2」のように番号が与えられる。

** ハードディスクパーティションの種類

path     | 種類
-------- | ---------
/dev/hda | プライマリマスター
/dev/hdb | プライマリスレーブ
/dev/hdc | セカンダリマスタ
/dev/hda | セカンダリスレーブ

確認するには、dfコマンドを使う。dfコマンドはLinuxカーネルが持つハードディスクに関する情報を表示することができる。

## ログとは

ログとは、Linuxの動作状況をログファイルとして記憶しておく仕組み。システム上の不具合や、セキュリティの脅威に対処するために必要な情報として利用される。ログはsyslogデーモンによって記録される場合と、ソフトウェア自身が記録をする場合の２つがある。

ソフトウェア自身が記録を持つものとして、WebサーバのApacheなどかある。Apacheは、記録形式などをユーザが設定することも可能。その場合には、ログ記録を行うプ####ムをソフトウェア自身が持たなくてはいけない。

### ログを見る

Linuxでは、システムの基本動作に関するログを/var/logディレクトリの中に種類別に幾つかのファイルに分けて記録されている。これらのファイルを参照すればシステムの状態や様々なエラーなどの警告を見ることができる。

ログの最新情報を見る場合、tailコマンドを使うと便利である。ログは、既存のファイルの末尾に情報を追加していくので、ファイルの後ほど最新のログが記述されていく。tailコマンドを用いると、末尾数行（デフォルトでは10行）のリグだけを見ることができる。

**ログの最新部分を表示する**

```
$ tail /var/log/messages

/var/log/messagesファイルの中に一般的なログが保存されている。
```

**ログをリアルタイムに表示する**

```
$ tail -f /var/log/messages
```

tailコマンドに-fオプションを付けて実行すると、末尾数行のログととも####ルタイムで発生したログも確認することができる。

### syslogのカスタマイズ

ログは、出力先ファイルなどをユーザ自身がカスタマイズすることもできる。/etc/syslog.confファイルに書くサービス毎に出力先ファイルや出力するログのレベルを設定することができる。syslogサービスは、各種ソフトウェアからのログ情報をまとめて出力するサービスである。

syslogはファシリティとプライオリティという２つの指標でログの情報を分類している。ファシリティはログの種類を示す。プライオリティはログの重要度・緊急性を示す。

**代表的なファシリティ**

ファシリティ   | 概要
-------- | -------------------
authpriv | 認証やセキュリティに関するログ
cron     | cronサービスに関するログ
daemon   | 各種デーモンに関するログ
kern     | カーネルから出力されるログ
lpr      | 印刷サービスから出力されるログ
mail     | メールサービスから出力されるログ
syslog   | syslog自体が内部的に出力するログ

**代表的なプライオリティ**

プライオリティ       | 概要
------------- | ------------------------------
emerg(panic)  | カーネルパニックなどシステム全体が機能不全に陥るようなエラー
alert         | ファイルシステムが破壊されるなど早急に修復すべきエラー
crit          | ハードウェアトラブルなどの致命的なエラー
err(error)    | 一般的なエラー
warn(warning) | 軽度の問題に関する通知
notice        | エラーではない状態に関する通知
info          | 一般的な情報
debug         | アプリケーションのデバックメッセージ
none          | 出力なし

ログの出力の設定は上記のファシリティ、プライオリティごとに行うことが可能。

## 参考サイト

[Begi.net](http://begi.net/read/base.html)
