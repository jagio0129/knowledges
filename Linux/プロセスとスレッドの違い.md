# プロセスとスレッドの違い

## 1 マルチタスクOSとプロセス

マルチタスクの機能は「同時に動いているようにみせているだけ」。ネットしながら音楽が聞けたりなど。

マルチタスクOSであっても、厳密にはCPUの数しかプログラムを同時に実行することはできない。CPUが１つなら一つのアプリケーションしか動いていない。

マルチタスクの機能によって実行するアプリケーションをものすごく細かく切り替えることで「同時に動いているように見せる」事ができる。

この時実行されているアプリケーションの１つ１つを「プロセス」という名前で管理している。

## 2 メモリの役割

メモリにはコンピュータが動作するための様々な情報が保持されている。

- 画面に表示する画像
- キーボードから入力された文字
- ハードディスクやUSBメモリに保存したファイル。
- 通信して受け取ったデータ など、実行中のプログラムが利用する情報は全てメモリに入れてから使う。

ここでの「実行中のプログラム」が「プロセス」のこと。

CPUがあるプロセスを実行するときは、そのプロセスが持っているメモリデータに対して演算を行う。

## 3. プロセスがメモリに保持している情報

プロセスの1つ1つは全て、以下のように２つのセグメントにわかれた構造のデータをメモリ上に持っている。

### テキストセグメント

- プログラムの命令列（実行されるプログラムそのもの） ＊読み取り専用

### データセグメント

- PDA(Processor Data Area)

  - プロセッサの情報やプロセス管理用のデータ領域 スタックポインタ（スタック領域のどこを見ているかを指す値）、プログラムカウンタ（プログラムのどこを実行しているかを指す値）などがここに格納される。

- データ領域

  - 静的領域

    - 定数やグローバル変数などが置かれるところ

  - ヒープ領域

    - 通常の変数などが格納されるところ プロセスが領域を増やしたり減らしたりするところなので、実行時までサイズがわからない。javaなどでのガベージコレクションはヒープ領域のデータが対象となる。

- スタック領域

  - 引数やローカルスコープのデータなどを一時的に置くところ

**プロセスがこのデータをメモリに持っている**と言うよりは、**プロセスがこのデータ構造としてメモリ上に存在している** という表現のほうが正しいかも。

## 4\. プロセスとスレッドの違い

あるプログラムを並列に実行する場合には、

1. 子プロセスを複数立ち上げて並列に動かす
2. スレッドを複数立ち上げて並列に動かす。

このどちらかの方法で、複数の処理を並列に動かすことができる。

### プロセス

プロセスをfork（プロセスをコピー）して子プロセスを複数立ち上げることで、同じプログラムを並列に動かすことができる。

子プロセスを炊いたげた時には子プロセス用のメモリ領域が新たに割り当てられる。そこに親プロセスのデータセグメントをコピーして、その子プロセス専用のデータセグメントを確保する。

動かすプログラムの命令自体は親プロセスと全く同じなので、テキストセグメントは親プロセスと同じ領域を参照する。

実行するプログラム自体は親プロセスと同じデータを共有し、実行状態に関わる変数などのデータは専用のものを利用することになる。 子プロセスも１つのプロセスとして扱われるので、他のプロセスのメモリに直接アクセスすることはできない。

ブラウザを何個か開いた時にそれぞれの画面で別々の操作ができる状態を想像するとわかりやすい。

### スレッド

プロセスからスレッドを生成することで同じプログラムを並列に動かすことができる。

スレッドが生成された時には親プロセスの仮想アドレス空間内に

- スタック領域
- スタックポインタ
- プログラムカウンタ

の値をスレッドごとにコピーして利用する。

それ以外のデータは全て親プロセスと同じものを利用する。 スレッドは小プロセスとは違い自分専用のメモリ領域は用意してもらえない。

つまり、親プロセルの領域の中にすべてのスレッドが存在していることになる。そのスレッドがいまプログラムのどの部分を実行しているかという情報だけを持ち、その他のデータは全てのスレッド間で同じものを利用する。

ほぼすべてのデータをほかスレッドと共有するので、あるスレッドが利用しようとしている変数が他のスレ度によって既に書き換えられていたり、消されていたりする状況が発生する。

シューティングゲームなどで、同じ画面上に主人公、敵キャラ、レーザービームがそれぞれバラバラに動くのを想像するとわかりやすい。

この状況で動作しても問題が発生しないプログラムのことを「スレッドセーフ」という。

## 5\. パフォーマンスの違い

- **プロセスは専用のメモリ領域を利用する**
- **スレッドは共有のメモリ領域を利用する**

ということになる。

### プロセスをたくさん立ち上げて動かす場合

プロセスはそれぞれに専用の仮想アドレス空間を保持しており、データセグメントのデータはそれぞれのメモリ領域内に保持されている。

そのため、プロセスを切り替える場合は仮想アドレス<=>物理アドレスのマッピングをそのプロセス用のものへの切り替える必要が出てくる。

一度アドレスを解決した結果はMMU（Memory Management Unit：プロセス毎に専用の物理メモリ領域を確保し、その物理領域にアクセスするための仮想アドレスを用意してくれる）がキャッシュしているため、そのままの状態でのプロセスを切り替えてしますと前のプロセスの領域が見えてしまうことになる。 なので、プロセスを切り替えるときはMMUが持っているキャッシュをクリアする必要がある。 ＊TLBフラッシュと呼ばれる

このTLBフラッシュがパフォーマンスに与える影響はかなり大きい。

### スレッドをたくさん立ち上げて動かす場合

スレッドが持つデータは全て親プロセスのメモリ領域内に保持されているため、利用する仮想アドレス空間を切り替える必要が無い。 そのためTLBフラッシュは必要ない。

実行するスレッドを切り替える場合は、スタック領域、スタックポインタ、プログラムカウンタの切り替えだけで済む。

# 参考サイト

<http://moro-archive.hatenablog.com/entry/2014/09/11/013520>
