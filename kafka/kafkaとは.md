kafkaとは
===

- スケーラビリティに優れた分散メッセージキュー
  - pub/subメッセージングモデルを採用
  - 読み書き性能を重視しており、MQTTなどの標準プロところではなく独自プロトコル
  - あとからでもクラスタにマシンを追加できるので、処理性能とデータ保持容量をスケールアウトできる
  - クラスタ内でデータを複製するので、一部のマシンに障害が発生してもデータを失うことなく処理を継続できる

## Pub/Subメッセージングモデルとは

![](https://itpfdoc.hitachi.co.jp/manuals/link/cosmi_v0970/03Y0760D/FIGURE/ZUJM060.GIF)

### 用語
- パブリッシャー
  - メッセージを作成して送信するクライアント(プロデューサー)
- サブスクライバー
  - メッセージを受診するクライアント(コンシューマー)
- ブローカー
  - メッセージを仲介する
  - メッセージをためている
- トピック
  - パブリッシャーが送信するメッセージの送り先。トピックを登録するという

### 特徴
- 一つ以上のパブリッシャーからトピックに登録
- 一つ以上のサブスクライバーが、トピックからメッセージを取り出して処理できる
- サブスクライバーは、配信を申し込んだトピックに登録されたメッセージすべてを受診して処理できる
  - ただし、メッセージセレクターで設定した基準に該当しないメッセージ、または受診する前にメッセージの有効期限が切れたメッセージについては受診しない
- メッセージはパブリッシャーが送信した順序でトピックに登録される
  - ただし、サブスクライバーで処理される順序は、メッセージの有効期限、優先順位、サブスクライバーで設定されたメッセージセレクターによって異なる
- パブリッシャーとサブスクライバーが処理を実行するタイミングには依存性がある
  - トピックに登録されたメッセージは、メッセージがトピックに登録される前にトピックに配信申し込みをしていたサブスクライバーにのみ配信される
- サブスクライバーの属性の「NoLocal」を指定した場合、サブスクライバーを使用しているコネクションと同じコネクションで送信されたメッセージの受診を抑止できる。デフォルトではfalse

### ユースケース
- IoTデバイスデータの収集
  - 大量にリアルタイムデータを収集し分析サービスやストレージに送信できる
- リアルタイムアナリティクス
  - ユーザアクションやイベントをリアルタイムで収集し、データ分析やダッシュボード表示に活用できる
- 分散システムの構築
  - サービス間でメッセージをやり取りすることで複雑な分散システムを構築できる
- ワークフローの自動化
  - タスクの完了をトリガーにして次のタスクを自動的に開始するようなものを実現できる
- モバイルアプリとの通信
  - モバイルアプリとサーバー感でリアルタイムメッセージをやり取りできる

## kafkaのシステム構成

![](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F285851%2F35ab4fa5-511f-c2a8-59e3-09c88ad7bfdd.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&w=1400&fit=max&s=7ab11222858ad1dda05379aff267bdc4)

- kafkaは複数のBrokerでクラスを構成。このクラスタ上にTopicと呼ばれる分散キューを構成する
- メッセージはキーバーリュー形式でRecordと呼ばれる
- 一つのTopicは複数のBrokerに分散配置されたPartitionで構成されている
  - このPartition単位でRecordの読み書きを行うことで、一つのTopicに対する並列IOを実現している
- Broker同士はクラスタコーディネータであるZookeeperを使用して連携し、Broker一つがリーダーとなりBrokerクラスタを管理する

### kafkaはキューではない？

キューであれば、保持したデータをfetchしたタイミングでデータは削除されるし、先頭のデータが消えない限り次のデータを処理できない。
しかしkafkaはデータを処理しても一定期間保持しているので消えない。

AWS SQSはキューである。AWS KinesisがKafkaに近い

# 参考

- [Apache Kafkaの概要とアーキテクチャ](https://qiita.com/sigmalist/items/5a26ab519cbdf1e07af3)
- [Cloud Pub/Sub 入門編: 概要や機能、ユースケースの解説](https://cloud-ace.jp/column/detail417/)
- [Pub/Subメッセージングモデル](https://itpfdoc.hitachi.co.jp/manuals/link/cosmi_v0970/03Y0760D/EY070390.HTM)
- [kafka Documentation](https://kafka.apache.org/documentation/)